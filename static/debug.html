<!DOCTYPE html>
<html>
<head>
    <title>Debug Bookmarks Storage</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .section { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        button { padding: 10px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Bookmarks Storage Debug</h1>
    
    <div class="section">
        <h3>Current localStorage Status</h3>
        <div id="storage-status">Loading...</div>
        <button onclick="refreshStatus()">Refresh Status</button>
        <button onclick="clearAllBookmarkData()">Clear All Bookmark Data</button>
    </div>
    
    <div class="section">
        <h3>Load Demo Data</h3>
        <button onclick="loadDemoData()">Load Demo Data from /demo-bookmarks.json</button>
        <div id="demo-status"></div>
    </div>
    
    <div class="section">
        <h3>Test Export</h3>
        <button onclick="testExport()">Test Export (main storage)</button>
        <button onclick="testExportWithData()">Test Export (with current data)</button>
        <div id="export-status"></div>
    </div>
    
    <div class="section">
        <h3>PWA Cache Debug</h3>
        <button onclick="debugPWA.fullReset()">Full PWA Reset (Clear all + reload)</button>
        <button onclick="debugPWA.clearAllCaches()">Clear All Caches</button>
        <button onclick="debugPWA.unregisterServiceWorker()">Unregister Service Worker</button>
        <button onclick="debugPWA.inspectCaches()">Inspect Caches (console)</button>
        <button onclick="debugPWA.checkServiceWorker()">Check Service Worker (console)</button>
        <div id="pwa-status">Check browser console for PWA debug output</div>
    </div>
    
    <script>
        // Storage keys
        const MAIN_STORAGE_KEY = 'bookmarks/cache-store';  // Now unified
        const OLD_STORAGE_KEY = 'bookmarks';  // For migration check
        
        function refreshStatus() {
            const mainData = localStorage.getItem(MAIN_STORAGE_KEY);
            const oldData = localStorage.getItem(OLD_STORAGE_KEY);
            
            let status = '<h4>Current Storage ("bookmarks/cache-store"):</h4>';
            if (mainData) {
                try {
                    const parsed = JSON.parse(mainData);
                    status += `<p>Found ${parsed.bookmarks ? parsed.bookmarks.length : 0} bookmarks</p>`;
                    status += `<pre>${JSON.stringify(parsed, null, 2).substring(0, 500)}...</pre>`;
                } catch (e) {
                    status += `<p>Error parsing: ${e.message}</p>`;
                }
            } else {
                status += '<p>No data found</p>';
            }
            
            status += '<h4>Old Storage ("bookmarks") - for migration check:</h4>';
            if (oldData) {
                try {
                    const parsed = JSON.parse(oldData);
                    status += `<p>‚ö†Ô∏è Found ${parsed.bookmarks ? parsed.bookmarks.length : 0} bookmarks in old location</p>`;
                    status += '<p><button onclick="migrateOldData()">Migrate Old Data</button></p>';
                    status += `<pre>${JSON.stringify(parsed, null, 2).substring(0, 500)}...</pre>`;
                } catch (e) {
                    status += `<p>Error parsing: ${e.message}</p>`;
                }
            } else {
                status += '<p>No old data found (good!)</p>';
            }
            
            document.getElementById('storage-status').innerHTML = status;
        }
        
        function clearAllBookmarkData() {
            localStorage.removeItem(MAIN_STORAGE_KEY);
            localStorage.removeItem(OLD_STORAGE_KEY);
            alert('Cleared both storage locations');
            refreshStatus();
        }
        
        function migrateOldData() {
            const oldData = localStorage.getItem(OLD_STORAGE_KEY);
            if (oldData) {
                localStorage.setItem(MAIN_STORAGE_KEY, oldData);
                localStorage.removeItem(OLD_STORAGE_KEY);
                alert('Migrated data from old location to new location');
                refreshStatus();
            }
        }
        
        async function loadDemoData() {
            try {
                const response = await fetch('/bookmarks/demo-bookmarks.json');
                const demoData = await response.json();
                
                // Save to main storage
                localStorage.setItem(MAIN_STORAGE_KEY, JSON.stringify(demoData));
                
                document.getElementById('demo-status').innerHTML = 
                    `<p>‚úÖ Loaded ${demoData.bookmarks.length} demo bookmarks to main storage</p>`;
                refreshStatus();
            } catch (e) {
                document.getElementById('demo-status').innerHTML = 
                    `<p>‚ùå Error loading demo data: ${e.message}</p>`;
            }
        }
        
        function testExport() {
            // Test export with no parameters (should load from localStorage)
            const mainData = localStorage.getItem(MAIN_STORAGE_KEY);
            if (mainData) {
                const parsed = JSON.parse(mainData);
                exportBookmarks();
                document.getElementById('export-status').innerHTML = 
                    `<p>üîç Called exportBookmarks() without parameters. Check console and downloads.</p>`;
            } else {
                document.getElementById('export-status').innerHTML = 
                    `<p>‚ùå No main storage data to export</p>`;
            }
        }
        
        function testExportWithData() {
            // Test export with explicit data parameter
            const mainData = localStorage.getItem(MAIN_STORAGE_KEY);
            if (mainData) {
                const parsed = JSON.parse(mainData);
                exportBookmarks(parsed);
                document.getElementById('export-status').innerHTML = 
                    `<p>üîç Called exportBookmarks(data) with ${parsed.bookmarks.length} bookmarks. Check console and downloads.</p>`;
            } else {
                document.getElementById('export-status').innerHTML = 
                    `<p>‚ùå No main storage data to export</p>`;
            }
        }
        
        // Simple export function for testing
        function exportBookmarks(data) {
            const exportData = data || JSON.parse(localStorage.getItem(MAIN_STORAGE_KEY) || '{"version":"2025-08-13","bookmarks":[]}');
            
            console.log('üîç Export function called with:', {
                dataProvided: !!data,
                exportDataBookmarks: exportData.bookmarks.length
            });
            
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `debug-bookmarks-${new Date().toISOString().split('T')[0]}.json`;
            a.style.display = 'none';
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
        }
        
        // Initialize
        refreshStatus();
        
        // PWA Debug Tools
        window.debugPWA = {
            async clearAllCaches() {
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    console.log('Found caches:', cacheNames);
                    
                    await Promise.all(
                        cacheNames.map(async (name) => {
                            const deleted = await caches.delete(name);
                            console.log(`Cache "${name}" deleted:`, deleted);
                        })
                    );
                    
                    console.log('All caches cleared!');
                    document.getElementById('pwa-status').innerHTML = `‚úÖ Cleared ${cacheNames.length} caches`;
                } else {
                    console.log('Cache API not supported');
                    document.getElementById('pwa-status').innerHTML = '‚ùå Cache API not supported';
                }
            },

            async unregisterServiceWorker() {
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    console.log('Found service worker registrations:', registrations.length);
                    
                    await Promise.all(
                        registrations.map(async (registration) => {
                            const unregistered = await registration.unregister();
                            console.log('Service worker unregistered:', unregistered);
                        })
                    );
                    
                    document.getElementById('pwa-status').innerHTML = `‚úÖ Unregistered ${registrations.length} service workers`;
                } else {
                    console.log('Service Worker not supported');
                    document.getElementById('pwa-status').innerHTML = '‚ùå Service Worker not supported';
                }
            },

            async fullReset() {
                console.log('üîÑ Starting full PWA reset...');
                await this.clearAllCaches();
                await this.unregisterServiceWorker();
                console.log('‚úÖ PWA reset complete. Refreshing page...');
                document.getElementById('pwa-status').innerHTML = 'üîÑ PWA reset complete. Refreshing...';
                setTimeout(() => window.location.reload(), 1000);
            },

            async inspectCaches() {
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    console.log('Available caches:', cacheNames);
                    
                    for (const name of cacheNames) {
                        const cache = await caches.open(name);
                        const keys = await cache.keys();
                        console.log(`\nCache "${name}" contains ${keys.length} items:`);
                        keys.forEach(request => console.log('  -', request.url));
                    }
                    
                    document.getElementById('pwa-status').innerHTML = `üîç Found ${cacheNames.length} caches. Check console for details.`;
                }
            },

            async checkServiceWorker() {
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    console.log('Service Worker registrations:', registrations);
                    
                    if (navigator.serviceWorker.controller) {
                        console.log('Active service worker:', navigator.serviceWorker.controller);
                        console.log('SW script URL:', navigator.serviceWorker.controller.scriptURL);
                        document.getElementById('pwa-status').innerHTML = `‚úÖ Active SW: ${navigator.serviceWorker.controller.scriptURL}`;
                    } else {
                        console.log('No active service worker controller');
                        document.getElementById('pwa-status').innerHTML = '‚ö†Ô∏è No active service worker controller';
                    }
                } else {
                    document.getElementById('pwa-status').innerHTML = '‚ùå Service Worker not supported';
                }
            }
        };
        
        console.log('üõ†Ô∏è PWA Debug tools loaded in debug.html!');
    </script>
</body>
</html>
