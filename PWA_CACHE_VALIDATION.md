# PWA Cache Validation System

## Overview

The PWA Cache Validation system detects when your cached PWA assets are stale and shows a notification to users when a refresh is needed. This solves the common problem where users see 404 errors after app updates because their service worker is serving outdated cached files.

## How It Works

### 1. Service Worker Version Tracking

The updated service worker (`static/service-worker.js`) now:
- Caches the `_app/version.json` file generated by SvelteKit
- Stores the current app version when installing
- Responds to version check messages from the client

### 2. Client-Side Cache Validator

The `CacheValidator` utility (`src/lib/utils/CacheValidator.ts`):
- Compares the cached version with the latest version from the server
- Provides methods to check cache status and force refresh
- Uses message passing to communicate with the service worker

### 3. UI Notification Component

The `CacheRefreshNotification` component (`src/lib/component/CacheRefreshNotification/`):
- Shows a non-intrusive notification when cache is stale
- Provides buttons to refresh the app or dismiss the notification
- Only checks on page load, no continuous polling

## Key Features

### Efficient Checking
- **Single Check on Load**: Only performs cache validation when the page loads
- **No Polling**: Unlike traditional PWA update notifications, this doesn't continuously poll
- **Event-Driven**: Uses service worker message events for real-time communication

### User-Friendly
- **Clear Notification**: Shows current vs. latest version info
- **Multiple Actions**: Refresh now, check again, or dismiss
- **Responsive Design**: Works on mobile and desktop
- **Non-Blocking**: Doesn't interfere with normal app usage

### Robust Error Handling
- **Timeout Protection**: 10-second timeout for version checks
- **Fallback Options**: Graceful degradation when service worker unavailable
- **Error Display**: Shows helpful error messages to users

## Usage

The system is automatically integrated into your main page:

```svelte
<!-- src/routes/+page.svelte -->
<CacheRefreshNotification />
```

### Manual Testing

You can test the cache validation in the browser console:

```javascript
// Check current cache status
const status = await window.cacheValidator.checkCacheStatus();
console.log(status);

// Force a refresh
await window.cacheValidator.forceRefresh();
```

## Configuration

### Cache Validation Intervals

The system checks for updates:
- Once on page load
- When manually triggered by the user
- When the service worker detects an update

### Service Worker Cache Strategy

The service worker (`CACHE_NAME: 'bookmarks-pwa-v2'`):
- Caches core app files including the version file
- Uses cache-first strategy for performance
- Automatically clears old caches on activation

## Implementation Details

### State Management

The cache validation uses a reactive state system:

```typescript
interface CacheStatus {
  isStale: boolean;
  currentVersion: string | null;
  latestVersion: string | null;
  lastCheck: Date;
  error?: string;
}
```

### Service Worker Communication

Uses MessageChannel API for bidirectional communication:

```javascript
// Client to SW
navigator.serviceWorker.controller.postMessage(
  { type: 'CHECK_VERSION' },
  [messageChannel.port2]
);

// SW to Client
event.ports[0].postMessage({
  type: 'VERSION_CHECK_RESULT',
  currentVersion,
  latestVersion,
  isStale
});
```

### Force Refresh Process

When users click "Refresh Now":

1. Clear all browser caches
2. Unregister service worker
3. Perform hard page reload
4. Fallback to simple reload if errors occur

## Benefits

### For Users
- **No More 404 Errors**: Automatically detects when cached assets are stale
- **Clear Action Path**: Simple "Refresh Now" button to fix issues
- **Non-Intrusive**: Shows notification only when needed

### For Developers
- **Reduced Support**: Fewer "app is broken" reports after deployments
- **Better UX**: Users always see the latest version after refresh
- **Debugging Friendly**: Clear version information and error messages

## Troubleshooting

### Common Issues

**Notification doesn't appear**:
- Check browser console for errors
- Ensure service worker is registered
- Verify `_app/version.json` is accessible

**Force refresh doesn't work**:
- Some browsers restrict cache clearing from scripts
- Users may need to manually clear browser data
- Consider showing manual refresh instructions

**Version check fails**:
- Network connectivity issues
- Service worker not responding (10-second timeout)
- CORS issues with version file access

### Debug Mode

Enable detailed logging:

```javascript
// In browser console
localStorage.setItem('debug-cache', 'true');
```

This will show detailed cache validation steps in the console.
